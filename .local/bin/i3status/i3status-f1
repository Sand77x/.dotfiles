#!/bin/bash
# for cron

i3status-f1() {
    local exec="$HOME/Projects/i3status/i3status-f1/get-next.sh"
    local file="$HOME/.cache/next_session"

    local output="$($exec)"
    if [ "$output" = "Season done!" ]; then
        echo "Race: $output" > "$file"
        exit
    fi

    local ts="${output##* }"
    local sesh="${output% *}"; sesh="${sesh##* }"
    local loc="${output% * *}"

    local diff=$(( ts - $(date +%s) ))
    local days=$(( diff / 86400 ))
    local hours=$(( (diff % 86400) / 3600 ))
    local mins=$(( (diff % 3600) / 60 ))

    local diff_str=""
    (( days > 0 )) && diff_str+="${days}d"
    (( hours > 0 )) && diff_str+="${hours}h"
    diff_str+="${mins}m"

    # only first 4 chars
    local loc_fmt="${loc//[[:space:]]/}"
    loc_fmt="${loc_fmt:0:4}"
    loc_fmt="${loc_fmt,,}"
    local content="F1: ${loc_fmt^} $sesh ~$diff_str"

    if (( days <= 3 )); then
        content="<span color=\"#ee8b2b\">$content</span>"
    fi

    echo "$content" > "$file"
}

i3status-f1

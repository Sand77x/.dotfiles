#!/usr/bin/env bash

# Directory locations where .desktop files normally live
DESKTOP_DIRS=(
    /usr/share/applications
    /usr/local/share/applications
    /var/lib/flatpak/exports/share/applications
    "$HOME/.local/share/applications"
)

# Gather all desktop files, extract the Name, and remember path
apps=$(for dir in "${DESKTOP_DIRS[@]}"; do
    [ -d "$dir" ] && grep -Rl "Exec=" "$dir" --include="*.desktop"
done | while read -r file; do
    name=$(grep -m1 "^Name=" "$file" | cut -d= -f2)
    echo -e "$name\t$file"
done | sort -f)

# Ask dmenu which app user picks
choice=$(echo "$apps" | cut -f1 | dmenu -i)

# Launch it
if [ -n "$choice" ]; then
    desktop_file=$(echo "$apps" | grep -P "^$choice\t" | cut -f2 | head -n 1)
    gtk-launch "$(basename "$desktop_file")"
fi

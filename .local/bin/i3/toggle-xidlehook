#!/usr/bin/env bash

cache="$HOME/.cache/xidlehook_status"
socket="/var/tmp/xidlehook.sock"
arg="$1"

query="$(xidlehook-client --socket "$socket" query 2>&1)"

# Not running
not_running() {
    echo "<span color='#ee8b2b'>Saver: NR</span>" > "$cache"
    [[ -z "$arg" ]] && dunstify -r 6767 -i system-lock-screen "Saver: NOT RUNNING"
    exit 0
}

# Turn ON
set_on() {
    echo "<span color='#8bee2b'>Saver: ON</span>" > "$cache"
    [[ -z "$arg" ]] && dunstify -r 6767 -i system-lock-screen "Saver: ON"
    xidlehook-client --socket "$socket" control --action enable 2>/dev/null
    xidlehook-client --socket "$socket" reset-idle 2>/dev/null
}

# Turn OFF
set_off() {
    echo "<span color='#ee8b2b'>Saver: OFF</span>" > "$cache"
    [[ -z "$arg" ]] && dunstify -r 6767 -i system-lock-screen "Saver: OFF"
    xidlehook-client --socket "$socket" control --action disable 2>/dev/null
}

# If xidlehook-client is not running
grep -q "Error" <<< "$query" && not_running

if [[ -n "$arg" ]]; then
    # With argument: check cache
    grep -q "OFF" "$cache" && set_off || set_on
else
    # No argument: toggle based on current state
    grep -q "disabled: true" <<< "$query" && set_on || set_off
fi

